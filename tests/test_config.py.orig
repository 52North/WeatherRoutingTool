<<<<<<< HEAD
import json
import pytest
from pathlib import Path
from WeatherRoutingTool.config import Config


def load_example_config():
    config_path = Path(__file__).parent / "config.tests_pydantic.json"
    with config_path.open("r") as f:
        return json.load(f), config_path


def test_assign_config_from_json():
    _, config_path = load_example_config()
    config = Config.assign_config(path=config_path, init_mode="from_json")

    assert isinstance(config, Config)
    assert config.CONFIG_PATH == config_path
    assert config.DEPARTURE_TIME is not None
    assert config.ISOCHRONE_PRUNE_SYMMETRY_AXIS == 'gcr'


def test_assign_config_from_dict():
    config_data, _ = load_example_config()
    config = Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert isinstance(config, Config)
    assert config.DEPARTURE_TIME is not None
    assert config.ISOCHRONE_PRUNE_SYMMETRY_AXIS == 'gcr'


def test_invalid_time_raises_error():
    config_data, _ = load_example_config()
    config_data["DEPARTURE_TIME"] = "2023-11-11T1111Z"
    with pytest.raises(ValueError) as excinfo:
        Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert "'DEPARTURE_TIME' must be in format YYYY-MM-DDTHH:MMZ" in str(excinfo.value)


def test_invalid_path_raises_error(tmp_path):
    config_data, _ = load_example_config()
    config_data["WEATHER_DATA"] = str(tmp_path / "nonexistent.nc")

    with pytest.raises(ValueError) as excinfo:
        Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert "Path doesn't exist" in str(excinfo.value)


def test_speedy_boat_validation_fails():
    config_data, _ = load_example_config()

    # Set inconsistent values
    config_data["BOAT_TYPE"] = "speedy_isobased"
    config_data["ALGORITHM_TYPE"] = "isofuel"

    with pytest.raises(ValueError) as excinfo:
        Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert "If 'BOAT_TYPE' or 'ALGORITHM_TYPE' is 'speedy_isobased'" in str(excinfo.value)


def test_invalid_route_raises_error():
    config_data, _ = load_example_config()
    config_data["DEFAULT_ROUTE"] = [54.15, 13.15, 54.56, 200]

    with pytest.raises(ValueError) as excinfo:
        Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert "lon_end must be between -180 and 180" in str(excinfo.value)


def test_negative_delta_fuel_raises_error():
    config_data, _ = load_example_config()
    config_data["DELTA_FUEL"] = -100
    with pytest.raises(ValueError) as excinfo:
        Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert "'DELTA_FUEL' must be greater than zero" in str(excinfo.value)


def test_non_even_router_hdgs_segments_raises_error():
    config_data, _ = load_example_config()
    config_data["ROUTER_HDGS_SEGMENTS"] = 31
    with pytest.raises(ValueError) as excinfo:
        Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert "'ROUTER_HDGS_SEGMENTS' must be a positive even integer" in str(excinfo.value)


def test_route_map_compatibility():
    config_data, _ = load_example_config()
    config_data["DEFAUL_ROUTE"] = [38.192, 13.392, 41.349, 17.188]
    with pytest.raises(ValueError) as excinfo:
        Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert "is outside the defined map bounds" in str(excinfo.value)


def test_weather_start_time_compatibility():
    config_data, _ = load_example_config()
    config_data["DEPARTURE_TIME"] = "2022-04-01T11:11Z"
    with pytest.raises(ValueError) as excinfo:
        Config.assign_config(init_mode="from_dict", config_dict=config_data)

    assert "Weather data does not cover the full routing time range." in str(excinfo.value)
=======
import pytest
from WeatherRoutingTool.config import Config


class TestConfig:
    @pytest.fixture(scope="class")
    def minimal_config(self):
        """A minimal valid config dictionary to use as a base for tests."""
        return {
            "DEFAULT_MAP": [30, -155, 65, -115],
            "DEFAULT_ROUTE": [37.416, -123.607, 58.760, -151.494],
            "DEPARTURE_TIME": "2023-11-11T11:11Z",
            "DEPTH_DATA": "path/to/depth_data",
            "ROUTE_PATH": "path/to/route.json",
            "WEATHER_DATA": "path/to/weather_data"
        }

    def test_valid_config_initialization(self, minimal_config):
        """Tests that a valid config does not raise an exception."""
        try:
            Config(init_mode='from_dict', config_dict=minimal_config)
        except ValueError as e:
            pytest.fail(f"Valid config raised an unexpected ValueError: {e}")

    def test_invalid_map_latitude_raises_error(self, minimal_config):
        """Tests that an out-of-range latitude in DEFAULT_MAP raises ValueError."""
        invalid_config = minimal_config.copy()
        invalid_config["DEFAULT_MAP"] = [30, -155, 95, -115]  # lat_max > 90
        with pytest.raises(ValueError, match="Latitudes in DEFAULT_MAP must be between -90 and 90"):
            Config(init_mode='from_dict', config_dict=invalid_config)

    def test_invalid_departure_time_format_raises_error(self, minimal_config):
        """Tests that an invalid DEPARTURE_TIME format raises ValueError."""
        invalid_config = minimal_config.copy()
        invalid_config["DEPARTURE_TIME"] = "2023/11/11 11:11"
        with pytest.raises(ValueError, match="DEPARTURE_TIME must be in the format 'yyyy-mm-ddThh:mmZ'"):
            Config(init_mode='from_dict', config_dict=invalid_config)

    def test_negative_delta_fuel_raises_error(self, minimal_config):
        """Tests that a negative DELTA_FUEL raises ValueError."""
        invalid_config = minimal_config.copy()
        invalid_config["DELTA_FUEL"] = -100
        with pytest.raises(ValueError, match="DELTA_FUEL must be a positive number"):
            Config(init_mode='from_dict', config_dict=invalid_config)

    def test_non_even_router_hdgs_segments_raises_error(self, minimal_config):
        """Tests that a non-even ROUTER_HDGS_SEGMENTS raises ValueError."""
        invalid_config = minimal_config.copy()
        invalid_config["ROUTER_HDGS_SEGMENTS"] = 31
        with pytest.raises(ValueError, match="ROUTER_HDGS_SEGMENTS must be a positive even integer"):
            Config(init_mode='from_dict', config_dict=invalid_config)
>>>>>>> origin/main
