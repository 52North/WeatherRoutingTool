<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WeatherRoutingTool.algorithms.genetic_utils &#8212; WeatherRoutingTool  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for WeatherRoutingTool.algorithms.genetic_utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">geographiclib.geodesic</span> <span class="kn">import</span> <span class="n">Geodesic</span>
<span class="kn">from</span> <span class="nn">pymoo.core.crossover</span> <span class="kn">import</span> <span class="n">Crossover</span>
<span class="kn">from</span> <span class="nn">pymoo.core.duplicate</span> <span class="kn">import</span> <span class="n">ElementwiseDuplicateElimination</span>
<span class="kn">from</span> <span class="nn">pymoo.core.mutation</span> <span class="kn">import</span> <span class="n">Mutation</span>
<span class="kn">from</span> <span class="nn">pymoo.core.problem</span> <span class="kn">import</span> <span class="n">ElementwiseProblem</span>
<span class="kn">from</span> <span class="nn">pymoo.core.sampling</span> <span class="kn">import</span> <span class="n">Sampling</span>
<span class="kn">from</span> <span class="nn">pymoo.core.repair</span> <span class="kn">import</span> <span class="n">Repair</span>
<span class="kn">from</span> <span class="nn">skimage.graph</span> <span class="kn">import</span> <span class="n">route_through_array</span>

<span class="kn">from</span> <span class="nn">WeatherRoutingTool.algorithms.data_utils</span> <span class="kn">import</span> <span class="n">GridMixin</span>
<span class="kn">from</span> <span class="nn">WeatherRoutingTool.routeparams</span> <span class="kn">import</span> <span class="n">RouteParams</span>
<span class="kn">from</span> <span class="nn">WeatherRoutingTool.utils.graphics</span> <span class="kn">import</span> <span class="n">plot_genetic_algorithm_initial_population</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;WRT.Genetic&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="GridBasedPopulation">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.GridBasedPopulation">[docs]</a>
<span class="k">class</span> <span class="nc">GridBasedPopulation</span><span class="p">(</span><span class="n">GridMixin</span><span class="p">,</span> <span class="n">Sampling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make initial population for genetic algorithm based on a grid and associated cost values</span>

<span class="sd">    Notes on the inheritance:</span>
<span class="sd">     - GridMixin has to be inherited first because Sampling isn&#39;t designed for multiple inheritance</span>
<span class="sd">     - implemented approach: https://stackoverflow.com/a/50465583, scenario 2</span>
<span class="sd">     - call print(GridBasedPopulation.mro()) to see the method resolution order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">var_type</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">var_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span>

    <span class="k">def</span> <span class="nf">_do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">routes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">start_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_to_index</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">end_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_to_index</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
            <span class="n">shuffled_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shuffled_cost</span><span class="p">()</span>
            <span class="n">route</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">route_through_array</span><span class="p">(</span><span class="n">shuffled_cost</span><span class="p">,</span> <span class="n">start_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="n">fully_connected</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">geometric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># logger.debug(f&quot;GridBasedPopulation._do: type(route)={type(route)}, route={route}&quot;)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_coords</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

            <span class="c1"># set initial and final points from the config file, to reach exact points</span>
            <span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span>
            <span class="n">route</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span>

            <span class="n">routes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

        <span class="n">plot_genetic_algorithm_initial_population</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">routes</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span></div>



<div class="viewcode-block" id="FromGeojsonPopulation">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.FromGeojsonPopulation">[docs]</a>
<span class="k">class</span> <span class="nc">FromGeojsonPopulation</span><span class="p">(</span><span class="n">Sampling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make initial population for genetic algorithm based on the isofuel algorithm with a ConstantFuelBoat</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">path_to_route_folder</span><span class="p">,</span> <span class="n">var_type</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_type</span> <span class="o">=</span> <span class="n">var_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">src</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_to_route_folder</span> <span class="o">=</span> <span class="n">path_to_route_folder</span>

    <span class="k">def</span> <span class="nf">_do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">routes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_samples</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="c1"># Routes have to be named route_1.json, route_2.json, etc.</span>
        <span class="c1"># See method find_routes_reaching_destination_in_current_step in isobased.py</span>
        <span class="c1"># ToDo: exit program with error when number of files is not equal to n_samples</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samples</span><span class="p">):</span>
            <span class="n">route_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_to_route_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;route_</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_route_from_file</span><span class="p">(</span><span class="n">route_file</span><span class="p">)</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">route_file</span><span class="si">}</span><span class="s2">&#39; couldn&#39;t be found. Use great circle route instead.&quot;</span><span class="p">)</span>
                <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_great_circle_route</span><span class="p">()</span>
                <span class="n">routes</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

        <span class="n">plot_genetic_algorithm_initial_population</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">routes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">routes</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span>

<div class="viewcode-block" id="FromGeojsonPopulation.get_great_circle_route">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.FromGeojsonPopulation.get_great_circle_route">[docs]</a>
    <span class="k">def</span> <span class="nf">get_great_circle_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get equidistant route along great circle in the form [[lat1, lon1], [lat12, lon2], ...]</span>
<span class="sd">        :param distance: distance in m</span>
<span class="sd">        :return: route as list of lat/lon points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">geod</span> <span class="o">=</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">WGS84</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">InverseLine</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">s13</span> <span class="o">/</span> <span class="n">distance</span><span class="p">))</span>
        <span class="n">route</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">distance</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">s13</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">Position</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">STANDARD</span> <span class="o">|</span> <span class="n">Geodesic</span><span class="o">.</span><span class="n">LONG_UNROLL</span><span class="p">)</span>
            <span class="n">route</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;lat2&#39;</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="s1">&#39;lon2&#39;</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">route</span></div>


<div class="viewcode-block" id="FromGeojsonPopulation.read_route_from_file">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.FromGeojsonPopulation.read_route_from_file">[docs]</a>
    <span class="k">def</span> <span class="nf">read_route_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route_absolute_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read route from geojson file and return the coordinates in the form [[lat1, lon1], [lat12, lon2], ...]</span>
<span class="sd">        :param route_absolute_path: absolute path to geojson file</span>
<span class="sd">        :return: route as list of lat/lon points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">route_absolute_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">rp_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">route</span> <span class="o">=</span> <span class="p">[[</span><span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">feature</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">][</span><span class="s1">&#39;coordinates&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
                 <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">rp_dict</span><span class="p">[</span><span class="s1">&#39;features&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="n">route</span></div>
</div>



<div class="viewcode-block" id="PopulationFactory">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.PopulationFactory">[docs]</a>
<span class="k">class</span> <span class="nc">PopulationFactory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="PopulationFactory.get_population">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.PopulationFactory.get_population">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_population</span><span class="p">(</span><span class="n">population_type</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">path_to_route_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">population_type</span> <span class="o">==</span> <span class="s1">&#39;grid_based&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For population type &#39;</span><span class="si">{</span><span class="n">population_type</span><span class="si">}</span><span class="s2">&#39;, a grid has to be provided!&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">population</span> <span class="o">=</span> <span class="n">GridBasedPopulation</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">grid</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">population_type</span> <span class="o">==</span> <span class="s1">&#39;from_geojson&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">path_to_route_folder</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path_to_route_folder</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path_to_route_folder</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;For population type &#39;</span><span class="si">{</span><span class="n">population_type</span><span class="si">}</span><span class="s2">&#39;, a valid route path has to be provided!&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">population</span> <span class="o">=</span> <span class="n">FromGeojsonPopulation</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">path_to_route_folder</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Population type &#39;</span><span class="si">{</span><span class="n">population_type</span><span class="si">}</span><span class="s2">&#39; is invalid!&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">population</span></div>
</div>



<div class="viewcode-block" id="GeneticCrossover">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.GeneticCrossover">[docs]</a>
<span class="k">class</span> <span class="nc">GeneticCrossover</span><span class="p">(</span><span class="n">Crossover</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom class to define genetic crossover for routes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="c1"># define the crossover: number of parents and number of offsprings</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob</span> <span class="o">=</span> <span class="n">prob</span>

    <span class="k">def</span> <span class="nf">_do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># The input of has the following shape (n_parents, n_matings, n_var)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">n_matings</span><span class="p">,</span> <span class="n">n_var</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_matings</span><span class="p">):</span>
            <span class="c1"># get the first and the second parent</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_over</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="c1"># print(&quot;Y:&quot;,Y)</span>
        <span class="k">return</span> <span class="n">Y</span>

<div class="viewcode-block" id="GeneticCrossover.cross_over">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.GeneticCrossover.cross_over">[docs]</a>
    <span class="k">def</span> <span class="nf">cross_over</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent1</span><span class="p">,</span> <span class="n">parent2</span><span class="p">):</span>
        <span class="c1"># src = parent1[0]</span>
        <span class="c1"># dest = parent1[-1]</span>
        <span class="n">intersect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parent1</span> <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">parent2</span><span class="p">)])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersect</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parent1</span><span class="p">,</span> <span class="n">parent2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cross_over_point</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">intersect</span><span class="p">)</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">parent1</span> <span class="o">==</span> <span class="n">cross_over_point</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">parent2</span> <span class="o">==</span> <span class="n">cross_over_point</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">child1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">parent1</span><span class="p">[:</span><span class="n">idx1</span><span class="p">],</span> <span class="n">parent2</span><span class="p">[</span><span class="n">idx2</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">child2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">parent2</span><span class="p">[:</span><span class="n">idx2</span><span class="p">],</span> <span class="n">parent1</span><span class="p">[</span><span class="n">idx1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># print(child1, child2)</span>
        <span class="k">return</span> <span class="n">child1</span><span class="p">,</span> <span class="n">child2</span></div>
</div>



<div class="viewcode-block" id="CrossoverFactory">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.CrossoverFactory">[docs]</a>
<span class="k">class</span> <span class="nc">CrossoverFactory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="CrossoverFactory.get_crossover">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.CrossoverFactory.get_crossover">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_crossover</span><span class="p">():</span>
        <span class="n">crossover</span> <span class="o">=</span> <span class="n">GeneticCrossover</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">crossover</span></div>
</div>



<div class="viewcode-block" id="GridBasedMutation">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.GridBasedMutation">[docs]</a>
<span class="k">class</span> <span class="nc">GridBasedMutation</span><span class="p">(</span><span class="n">GridMixin</span><span class="p">,</span> <span class="n">Mutation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom class to define genetic mutation for routes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob</span> <span class="o">=</span> <span class="n">prob</span>

    <span class="k">def</span> <span class="nf">_do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">offsprings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="c1"># loop over individuals in population</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
            <span class="c1"># perform mutation with certain probability</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob</span><span class="p">:</span>
                <span class="n">mutated_individual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutate</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># print(&quot;mutated_individual&quot;, mutated_individual, &quot;###&quot;)</span>
                <span class="n">offsprings</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mutated_individual</span>
            <span class="c1"># if no mutation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">offsprings</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">offsprings</span>

<div class="viewcode-block" id="GridBasedMutation.mutate">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.GridBasedMutation.mutate">[docs]</a>
    <span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">start_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_to_index</span><span class="p">([(</span><span class="n">route</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">route</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">end_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords_to_index</span><span class="p">([(</span><span class="n">route</span><span class="p">[</span><span class="n">end</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">route</span><span class="p">[</span><span class="n">end</span><span class="p">][</span><span class="mi">1</span><span class="p">])])</span>

        <span class="n">shuffled_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_shuffled_cost</span><span class="p">()</span>
        <span class="n">subpath</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">route_through_array</span><span class="p">(</span><span class="n">shuffled_cost</span><span class="p">,</span> <span class="n">start_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">fully_connected</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">geometric</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">subpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_coords</span><span class="p">(</span><span class="n">subpath</span><span class="p">)</span>
        <span class="n">newPath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">route</span><span class="p">[:</span><span class="n">start</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">subpath</span><span class="p">),</span> <span class="n">route</span><span class="p">[</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newPath</span></div>
</div>



<div class="viewcode-block" id="MutationFactory">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.MutationFactory">[docs]</a>
<span class="k">class</span> <span class="nc">MutationFactory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="MutationFactory.get_mutation">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.MutationFactory.get_mutation">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_mutation</span><span class="p">(</span><span class="n">mutation_type</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mutation_type</span> <span class="o">==</span> <span class="s1">&#39;grid_based&#39;</span><span class="p">:</span>
            <span class="n">mutation</span> <span class="o">=</span> <span class="n">GridBasedMutation</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Mutation type &#39;</span><span class="si">{</span><span class="n">mutation_type</span><span class="si">}</span><span class="s2">&#39; is invalid!&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mutation</span></div>
</div>



<div class="viewcode-block" id="RoutingProblem">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.RoutingProblem">[docs]</a>
<span class="k">class</span> <span class="nc">RoutingProblem</span><span class="p">(</span><span class="n">ElementwiseProblem</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class definition of the weather routing problem</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">boat</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">constraint_list</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">departure_time</span><span class="p">:</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">departure_time</span><span class="p">,</span> <span class="n">boat</span><span class="p">,</span> <span class="n">constraint_list</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">n_var</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_obj</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_constr</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boat</span> <span class="o">=</span> <span class="n">boat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_list</span> <span class="o">=</span> <span class="n">constraint_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">departure_time</span> <span class="o">=</span> <span class="n">departure_time</span>

    <span class="k">def</span> <span class="nf">_evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method defined by pymoo which has to be overriden</span>
<span class="sd">        :param x: numpy matrix with shape (rows: number of solutions/individuals, columns: number of design variables)</span>
<span class="sd">        :param out:</span>
<span class="sd">            out[&#39;F&#39;]: function values, vector of length of number of solutions</span>
<span class="sd">            out[&#39;G&#39;]: constraints</span>
<span class="sd">        :param args:</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># logger.debug(f&quot;RoutingProblem._evaluate: type(x)={type(x)}, x.shape={x.shape}, x={x}&quot;)</span>
        <span class="n">fuel</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_power</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_constraints</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># print(costs.shape)</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">fuel</span><span class="p">])</span>
        <span class="n">out</span><span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">constraints</span><span class="p">])</span>

<div class="viewcode-block" id="RoutingProblem.is_neg_constraints">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.RoutingProblem.is_neg_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">is_neg_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lat</span><span class="p">])</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lon</span><span class="p">])</span>
        <span class="n">is_constrained</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">is_constrained</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_list</span><span class="o">.</span><span class="n">safe_endpoint</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">is_constrained</span><span class="p">)</span>
        <span class="c1"># print(is_constrained)</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">is_constrained</span> <span class="k">else</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="RoutingProblem.get_constraints_array">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.RoutingProblem.get_constraints_array">[docs]</a>
    <span class="k">def</span> <span class="nf">get_constraints_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return constraint violation per waypoint in route</span>

<span class="sd">        :param route: Candidate array of waypoints</span>
<span class="sd">        :type route: np.ndarray</span>
<span class="sd">        :return: Array of constraint violations</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">constraints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">is_neg_constraints</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="ow">in</span> <span class="n">route</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">constraints</span></div>


<div class="viewcode-block" id="RoutingProblem.get_constraints">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.RoutingProblem.get_constraints">[docs]</a>
    <span class="k">def</span> <span class="nf">get_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
        <span class="c1"># ToDo: what about time?</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_constraints_array</span><span class="p">(</span><span class="n">route</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">constraints</span></div>


<div class="viewcode-block" id="RoutingProblem.get_power">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.RoutingProblem.get_power">[docs]</a>
    <span class="k">def</span> <span class="nf">get_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
        <span class="n">route_dict</span> <span class="o">=</span> <span class="n">RouteParams</span><span class="o">.</span><span class="n">get_per_waypoint_coords</span><span class="p">(</span><span class="n">route</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">route</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">departure_time</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">boat</span><span class="o">.</span><span class="n">get_boat_speed</span><span class="p">())</span>

        <span class="n">shipparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boat</span><span class="o">.</span><span class="n">get_ship_parameters</span><span class="p">(</span><span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;courses&#39;</span><span class="p">],</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;start_lats&#39;</span><span class="p">],</span>
                                                   <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;start_lons&#39;</span><span class="p">],</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;start_times&#39;</span><span class="p">])</span>
        <span class="n">fuel</span> <span class="o">=</span> <span class="n">shipparams</span><span class="o">.</span><span class="n">get_fuel_rate</span><span class="p">()</span>
        <span class="n">fuel</span> <span class="o">=</span> <span class="p">(</span><span class="n">fuel</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span> <span class="o">*</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;travel_times&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fuel</span><span class="p">),</span> <span class="n">shipparams</span></div>
</div>



<div class="viewcode-block" id="RouteDuplicateElimination">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.RouteDuplicateElimination">[docs]</a>
<span class="k">class</span> <span class="nc">RouteDuplicateElimination</span><span class="p">(</span><span class="n">ElementwiseDuplicateElimination</span><span class="p">):</span>

<div class="viewcode-block" id="RouteDuplicateElimination.is_equal">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.RouteDuplicateElimination.is_equal">[docs]</a>
    <span class="k">def</span> <span class="nf">is_equal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>
</div>



<span class="c1"># Repair Population</span>

<div class="viewcode-block" id="RepairInfeasibles">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.algorithms.html#WeatherRoutingTool.algorithms.genetic_utils.RepairInfeasibles">[docs]</a>
<span class="k">class</span> <span class="nc">RepairInfeasibles</span><span class="p">(</span><span class="n">Repair</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repairs infeasible candidates of a population</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_repair_candidate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">constraints</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Repair the waypoints of a route when a constraint violation is found.</span>

<span class="sd">        NOTE: Currently replaces the waypoint with the previous one in the</span>
<span class="sd">        route, which is not feasible at all; need to incorporate a closest</span>
<span class="sd">        feasible waypoint finding method</span>

<span class="sd">        :param route: Candidate solution array</span>
<span class="sd">        :type route: np.ndarray</span>
<span class="sd">        :param constraints: Constraints array indicating violations with waypoints</span>
<span class="sd">        :type constraints: np.ndarray</span>
<span class="sd">        :return: Updated Candidate array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">constraints</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># TODO: Adjust to replace waypoint with a feasible one instead of the previous one</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">route</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">route</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">route</span>

    <span class="k">def</span> <span class="nf">_do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">problem</span><span class="p">:</span> <span class="n">RoutingProblem</span><span class="p">,</span> <span class="n">Z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fix routes when waypoints do not meet the constraints</span>

<span class="sd">        :param problem: Problem being solved by the algorithm</span>
<span class="sd">        :type problem: RoutingProblem</span>
<span class="sd">        :param Z: Candidate solution array</span>
<span class="sd">        :type Z: np.ndarray</span>
<span class="sd">        :return: Array of updated population</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">problem</span><span class="o">.</span><span class="n">get_constraints_array</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Z</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">constraints</span><span class="p">):</span>
            <span class="c1"># if any constraint is broken in the route</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_repair_candidate</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Z</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">WeatherRoutingTool</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/constraints/index.html">Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/consumption-models/index.html">Consumption models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/weather.html">Weather data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/api-documentation/index.html">API documentation (still under construction!)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/uml.html">UML Class diagrams</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, 52°North Spatial Information Research GmbH.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>