<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WeatherRoutingTool.constraints.route_postprocessing &#8212; WeatherRoutingTool  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b76e3c8a" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for WeatherRoutingTool.constraints.route_postprocessing</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">geovectorslib</span> <span class="kn">import</span> <span class="n">geod</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">box</span><span class="p">,</span> <span class="n">LineString</span><span class="p">,</span> <span class="n">Point</span>
<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="kn">import</span> <span class="n">polygonize_full</span>

<span class="kn">from</span> <span class="nn">WeatherRoutingTool.routeparams</span> <span class="kn">import</span> <span class="n">RouteParams</span>
<span class="kn">from</span> <span class="nn">WeatherRoutingTool.ship.ship</span> <span class="kn">import</span> <span class="n">Boat</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;WRT.RoutePostprocessing&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="RoutePostprocessing">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing">[docs]</a>
<span class="k">class</span> <span class="nc">RoutePostprocessing</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Currently RoutePostprocessing is focused on Traffic Separation Scheme.</span>
<span class="sd">    In the future, it should be integrated into a more general approach.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">route</span><span class="p">:</span> <span class="n">RouteParams</span>
    <span class="n">lats_per_step</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">lons_per_step</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">starttime_per_step</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">ship_speed</span><span class="p">:</span> <span class="nb">list</span>
    <span class="n">boat</span><span class="p">:</span> <span class="n">Boat</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_fuel_route</span><span class="p">,</span> <span class="n">boat</span><span class="p">,</span> <span class="n">db_engine</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">min_fuel_route</span><span class="p">,</span> <span class="n">boat</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">db_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">db_engine</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WRT_DB_HOST&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">database</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WRT_DB_DATABASE&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WRT_DB_USERNAME&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WRT_DB_PASSWORD&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_SCHEMA&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;WRT_DB_PORT&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_database</span><span class="p">()</span>

<div class="viewcode-block" id="RoutePostprocessing.set_data">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.set_data">[docs]</a>
    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">boat</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">route</span> <span class="o">=</span> <span class="n">route</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">lats_per_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">lons_per_step</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">starttime_per_step</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">starttime_per_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boat</span> <span class="o">=</span> <span class="n">boat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ship_speed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boat</span><span class="o">.</span><span class="n">get_boat_speed</span><span class="p">()</span></div>


<div class="viewcode-block" id="RoutePostprocessing.post_process_route">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.post_process_route">[docs]</a>
    <span class="k">def</span> <span class="nf">post_process_route</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">route_bbx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_route_bbox</span><span class="p">()</span>
        <span class="n">route_segments_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_route_segments</span><span class="p">()</span>
        <span class="n">seamark_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_seamark_data</span><span class="p">(</span><span class="n">route_bbx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

        <span class="n">intersecting_route_node_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_seamark_intersections</span><span class="p">(</span><span class="n">route_segments_gdf</span><span class="p">,</span> <span class="n">seamark_gdf</span><span class="p">)</span>
        <span class="n">no_of_intersections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersecting_route_node_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">no_of_intersections</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_start_or_finish_node_in_separation_zone</span><span class="p">(</span>
                    <span class="n">route_segments_gdf</span><span class="p">,</span> <span class="n">seamark_gdf</span><span class="p">):</span>
                <span class="n">route_postprocessed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span>
                <span class="k">return</span> <span class="n">route_postprocessed</span>

            <span class="n">first_route_seg_gdf</span> <span class="o">=</span> <span class="n">route_segments_gdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">intersecting_route_node_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">last_route_node_intersecting</span> <span class="o">=</span> <span class="n">intersecting_route_node_list</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">intersecting_route_node_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">first_node_index_of_last_route_seg</span> <span class="o">=</span> <span class="n">last_route_node_intersecting</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">last_route_seg_gdf</span> <span class="o">=</span> <span class="n">route_segments_gdf</span><span class="p">[</span><span class="n">first_node_index_of_last_route_seg</span><span class="p">:]</span>

            <span class="n">separation_lanes_data_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retrieve_seperation_lane_data</span><span class="p">(</span><span class="n">route_bbx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">empty</span> <span class="ow">or</span> <span class="n">last_route_seg_gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># Handle scenarios when there is an intersection in the first segment of the route</span>
                <span class="c1"># or the last segment of the route or in both first and last segments of the route</span>
                <span class="n">last_node_of_route_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_first_node_of_route_seg</span><span class="p">(</span><span class="n">route_segments_gdf</span><span class="p">)</span>
                <span class="n">separation_lane_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_seperation_lane_to_follow</span><span class="p">(</span><span class="n">last_node_of_route_seg</span><span class="p">,</span>
                                                                          <span class="n">separation_lanes_data_gdf</span><span class="p">)</span>
                <span class="n">final_route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_route_segments</span><span class="p">(</span><span class="n">first_route_seg_gdf</span><span class="p">,</span> <span class="n">separation_lane_gdf</span><span class="p">,</span>
                                                          <span class="n">last_route_seg_gdf</span><span class="p">,</span> <span class="n">route_segments_gdf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">last_node_of_first_route_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_last_node_of_route_seg</span><span class="p">(</span><span class="n">first_route_seg_gdf</span><span class="p">)</span>
                <span class="n">first_node_of_last_route_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_first_node_of_route_seg</span><span class="p">(</span><span class="n">last_route_seg_gdf</span><span class="p">)</span>
                <span class="n">is_valid_90_crossing</span><span class="p">,</span> <span class="n">separation_lane_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_valid_crossing</span><span class="p">(</span><span class="n">separation_lanes_data_gdf</span><span class="p">,</span>
                                                                                          <span class="n">last_node_of_first_route_seg</span><span class="p">,</span>
                                                                                          <span class="n">first_node_of_last_route_seg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">is_valid_90_crossing</span><span class="p">:</span>
                    <span class="n">x_point_on_lane</span><span class="p">,</span> <span class="n">y_point_on_lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_point_from_perpendicular_angle</span><span class="p">(</span>
                                                            <span class="n">last_node_of_first_route_seg</span><span class="p">,</span> <span class="n">separation_lane_segment</span><span class="p">)</span>
                    <span class="n">perpendicular_line_segment</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([</span><span class="n">last_node_of_first_route_seg</span><span class="p">,</span>
                                                             <span class="p">(</span><span class="n">x_point_on_lane</span><span class="p">,</span> <span class="n">y_point_on_lane</span><span class="p">)])</span>
                    <span class="n">end_node_x</span><span class="p">,</span> <span class="n">end_node_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_point_from_perpendicular_angle</span><span class="p">(</span><span class="n">first_node_of_last_route_seg</span><span class="p">,</span>
                                                                                      <span class="n">perpendicular_line_segment</span><span class="p">)</span>
                    <span class="n">extended_line</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([</span><span class="n">last_node_of_first_route_seg</span><span class="p">,</span> <span class="p">(</span><span class="n">x_point_on_lane</span><span class="p">,</span> <span class="n">y_point_on_lane</span><span class="p">),</span>
                                                <span class="p">(</span><span class="n">end_node_x</span><span class="p">,</span> <span class="n">end_node_y</span><span class="p">)])</span>
                    <span class="n">extended_line_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="s1">&#39;epsg:4326&#39;</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">extended_line</span><span class="p">])</span>
                    <span class="n">extended_line_gdf</span><span class="o">.</span><span class="n">rename_geometry</span><span class="p">(</span><span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">connecting_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_last_connecting_line</span><span class="p">(</span><span class="n">last_route_seg_gdf</span><span class="p">,</span>
                                                                       <span class="n">extended_line_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">connecting_line_to_last_route_seg_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">connecting_line</span><span class="p">],</span>
                                                                             <span class="n">crs</span><span class="o">=</span><span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
                    <span class="n">connecting_line_to_last_route_seg_gdf</span><span class="o">.</span><span class="n">rename_geometry</span><span class="p">(</span><span class="s1">&#39;geom&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">final_route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_route_segments</span><span class="p">(</span><span class="n">first_route_seg_gdf</span><span class="p">,</span>
                                                              <span class="n">connecting_line_to_last_route_seg_gdf</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                              <span class="n">last_route_seg_gdf</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">separation_lane_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_seperation_lane_to_follow</span><span class="p">(</span><span class="n">last_node_of_first_route_seg</span><span class="p">,</span>
                                                                              <span class="n">separation_lanes_data_gdf</span><span class="p">)</span>
                    <span class="n">final_route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect_route_segments</span><span class="p">(</span><span class="n">first_route_seg_gdf</span><span class="p">,</span> <span class="n">separation_lane_gdf</span><span class="p">,</span>
                                                              <span class="n">last_route_seg_gdf</span><span class="p">)</span>
            <span class="n">starttime_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recalculate_starttime_per_node</span><span class="p">(</span><span class="n">final_route</span><span class="p">)</span>

            <span class="n">route_postprocessed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">,</span>
                                                 <span class="n">starttime_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ship_speed</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; Route postprocessing is not continued as the route does &#39;</span>
                        <span class="s1">&#39;not intersect any Traffic Separation Schemes&#39;</span><span class="p">)</span>
            <span class="n">route_postprocessed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span>

        <span class="k">return</span> <span class="n">route_postprocessed</span></div>


<div class="viewcode-block" id="RoutePostprocessing.connect_database">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.connect_database">[docs]</a>
    <span class="k">def</span> <span class="nf">connect_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql://</span><span class="si">{user}</span><span class="s2">:</span><span class="si">{pwd}</span><span class="s2">@</span><span class="si">{host}</span><span class="s2">:</span><span class="si">{port}</span><span class="s2">/</span><span class="si">{db}</span><span class="s2">&quot;</span><span class="o">.</span>
                                          <span class="nb">format</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">pwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                                                 <span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">engine</span></div>


<div class="viewcode-block" id="RoutePostprocessing.create_route_segments">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.create_route_segments">[docs]</a>
    <span class="k">def</span> <span class="nf">create_route_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create relevant line segments from the nodes(coordinates) of the minimum fuel route</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">route_segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])])</span>
            <span class="n">route_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>

            <span class="n">timestamp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">starttime_per_step</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Add LineString segments to a new GeoDataFrame</span>
        <span class="n">route_segments_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">({</span><span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">},</span> <span class="n">geometry</span><span class="o">=</span><span class="n">route_segments</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">route_segments_gdf</span></div>


<div class="viewcode-block" id="RoutePostprocessing.get_route_bbox">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.get_route_bbox">[docs]</a>
    <span class="k">def</span> <span class="nf">get_route_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">min_lat</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">min_lon</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">max_lat</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">max_lon</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

        <span class="n">bbox</span> <span class="o">=</span> <span class="n">box</span><span class="p">(</span><span class="n">min_lon</span><span class="p">,</span> <span class="n">min_lat</span><span class="p">,</span> <span class="n">max_lon</span><span class="p">,</span> <span class="n">max_lat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bbox</span></div>


<div class="viewcode-block" id="RoutePostprocessing.query_data">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.query_data">[docs]</a>
    <span class="k">def</span> <span class="nf">query_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="n">gdf_seamark</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_postgis</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gdf_seamark</span></div>


<div class="viewcode-block" id="RoutePostprocessing.retrieve_seamark_data">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.retrieve_seamark_data">[docs]</a>
    <span class="k">def</span> <span class="nf">retrieve_seamark_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox_wkt</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve all the seamark objects within the bounding box</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT *,linestring AS geom FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">+</span> <span class="s2">&quot;.ways &quot;</span> \
                <span class="s2">&quot;WHERE  (tags -&gt; &#39;seamark:type&#39;=&#39;separation_boundary&#39; OR tags -&gt; &#39;seamark:type&#39;=&#39;separation_line&#39; &quot;</span> \
                <span class="s2">&quot;OR tags -&gt; &#39;seamark:type&#39;=&#39;separation_zone&#39; OR tags -&gt; &#39;seamark:type&#39;=&#39;separation_lane&#39; &quot;</span> \
                <span class="s2">&quot;OR tags -&gt; &#39;seamark:type&#39;=&#39;inshore_traffic_zone&#39;)&quot;</span> \
                <span class="s2">&quot;AND ST_Intersects(linestring, ST_GeomFromText(&#39;</span><span class="si">{}</span><span class="s2">&#39;, 4326))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bbox_wkt</span><span class="p">)</span>
        <span class="n">seamark_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seamark_gdf</span></div>


<div class="viewcode-block" id="RoutePostprocessing.find_seamark_intersections">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.find_seamark_intersections">[docs]</a>
    <span class="k">def</span> <span class="nf">find_seamark_intersections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route_segments_gdf</span><span class="p">,</span> <span class="n">seamark_gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        First, find intersection points of route segments with any seamark object.</span>
<span class="sd">        If any intersection is available, then iterate over each route segment and the intersection points</span>
<span class="sd">        to identify which route segment is getting intersected with the intersection point.</span>
<span class="sd">        Then, the relevant route segment is added to the list of indices of intersected route segments</span>

<span class="sd">        :param route_segments_gdf: geodataframe of ship route segments</span>
<span class="sd">        :param seamark_gdf: geodataframe of all seamark TSS objects within the bounding box of the route</span>
<span class="sd">        :returns: The list of route segment indices which intersects the TSS seamark objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intersection_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">route_segments_gdf</span><span class="p">,</span> <span class="n">seamark_gdf</span><span class="p">,</span>
                                       <span class="n">how</span><span class="o">=</span><span class="s1">&#39;intersection&#39;</span><span class="p">,</span> <span class="n">keep_geom_type</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">intersected_route_indices_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index_seg</span><span class="p">,</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">route_segments_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">index_in</span><span class="p">,</span> <span class="n">intersecting_point</span> <span class="ow">in</span> <span class="n">intersection_gdf</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="c1"># All floating point calculations are limited by the machine epsilon(round off method).</span>
                <span class="c1"># The intersected points are interpolated from geometries of the linestrings, and</span>
                <span class="c1"># they are exact only when there&#39;s a right angle. All of the DE-9IM predicates like &#39;intersects&#39;</span>
                <span class="c1"># requires exact node. Therefore, 2 strategies can be applied in this scenario. Setting a buffer</span>
                <span class="c1"># or test the distance between the geometries.</span>
                <span class="c1"># Tolerance: 1° is approx 110km. Hence, 10^-12 of 110 km is 110 picometers.</span>
                <span class="n">EPS</span> <span class="o">=</span> <span class="mf">1e-12</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">intersecting_point</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">EPS</span>
                <span class="k">if</span> <span class="n">dist</span><span class="p">:</span>
                    <span class="n">intersected_route_indices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_seg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">intersected_route_indices_list</span></div>


<div class="viewcode-block" id="RoutePostprocessing.is_start_or_finish_node_in_separation_zone">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.is_start_or_finish_node_in_separation_zone">[docs]</a>
    <span class="k">def</span> <span class="nf">is_start_or_finish_node_in_separation_zone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route_segments_gdf</span><span class="p">,</span> <span class="n">seamark_gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find whether seamark TSS objects contains the starting or ending node of the</span>
<span class="sd">        route. If contains, the route is not forwarded for postprocessing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_route_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_first_node_of_route_seg</span><span class="p">(</span><span class="n">route_segments_gdf</span><span class="p">)</span>
        <span class="n">last_route_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_last_node_of_route_seg</span><span class="p">(</span><span class="n">route_segments_gdf</span><span class="p">)</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">cuts</span><span class="p">,</span> <span class="n">dangles</span><span class="p">,</span> <span class="n">invalids</span> <span class="o">=</span> <span class="n">polygonize_full</span><span class="p">(</span><span class="n">seamark_gdf</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">])</span>
        <span class="n">contains_first_node</span> <span class="o">=</span> <span class="n">first_route_node</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">contains_last_node</span> <span class="o">=</span> <span class="n">last_route_node</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contains_first_node</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39; Route postprocessing is not continued as the start point is &#39;</span>
                           <span class="s1">&#39;inside the Traffic Separation Zone!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">contains_last_node</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39; Route postprocessing is not continued as the finish point is &#39;</span>
                           <span class="s1">&#39;inside the Traffic Separation Zone!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="RoutePostprocessing.find_last_node_of_route_seg">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.find_last_node_of_route_seg">[docs]</a>
    <span class="k">def</span> <span class="nf">find_last_node_of_route_seg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_route_seg_gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the node of the route segments before the first intersecting point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">last_line_geom</span> <span class="o">=</span> <span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">()</span>
        <span class="n">last_node_geom</span> <span class="o">=</span> <span class="n">last_line_geom</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">last_node</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">last_node_geom</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">last_node_geom</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">last_node</span></div>


<div class="viewcode-block" id="RoutePostprocessing.find_first_node_of_route_seg">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.find_first_node_of_route_seg">[docs]</a>
    <span class="k">def</span> <span class="nf">find_first_node_of_route_seg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route_seg_gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the node of the route segments after the last intersecting point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">first_line_geom</span> <span class="o">=</span> <span class="n">route_seg_gdf</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">()</span>
        <span class="n">first_node_geom</span> <span class="o">=</span> <span class="n">first_line_geom</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">first_node</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">first_node_geom</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">first_node_geom</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">first_node</span></div>


<div class="viewcode-block" id="RoutePostprocessing.retrieve_seperation_lane_data">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.retrieve_seperation_lane_data">[docs]</a>
    <span class="k">def</span> <span class="nf">retrieve_seperation_lane_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bbox_wkt</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT *,linestring AS geom FROM public.ways WHERE  ( tags -&gt; &#39;seamark:type&#39;=&#39;separation_lane&#39;) &quot;</span> \
                <span class="s2">&quot;AND ST_Intersects(linestring, ST_GeomFromText(&#39;</span><span class="si">{}</span><span class="s2">&#39;, 4326))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bbox_wkt</span><span class="p">)</span>
        <span class="n">separation_lanes_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_data</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">separation_lanes_gdf</span></div>


<div class="viewcode-block" id="RoutePostprocessing.find_seperation_lane_to_follow">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.find_seperation_lane_to_follow">[docs]</a>
    <span class="k">def</span> <span class="nf">find_seperation_lane_to_follow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_node</span><span class="p">,</span> <span class="n">seperation_lanes_gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The direction of the separation lane is determined by the order of the points in the linestring.</span>
<span class="sd">        Hence, it is assumed the nearest starting point of the separation lane</span>
<span class="sd">        (when in parallel and opposite directions) need to be followed.</span>
<span class="sd">        This is achieved by finding the distances between the route node before the first intersection and the starting</span>
<span class="sd">        node of the each separation lane. Then the separation lane having the minimum distance is selected.</span>

<span class="sd">        :param last_node: the node of the route segments before the first intersecting point</span>
<span class="sd">        :param seperation_lanes_gdf: geodataframe of separation lanes</span>
<span class="sd">        :returns: geodataframe of the separation lane need to be followed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">seperation_lanes_gdf</span><span class="o">.</span><span class="n">geom</span><span class="p">:</span>
            <span class="n">seamark_lane_segment</span> <span class="o">=</span> <span class="n">line</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">seamark_lane_segment</span><span class="o">.</span><span class="n">xy</span>
            <span class="n">seamark_starting_node</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">last_node</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">seamark_starting_node</span><span class="p">)</span>
            <span class="n">dist_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>

        <span class="n">min_dist_index</span> <span class="o">=</span> <span class="n">dist_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">dist_list</span><span class="p">))</span>
        <span class="n">seperation_lane_gdf</span> <span class="o">=</span> <span class="n">seperation_lanes_gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_dist_index</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">seperation_lane_gdf</span></div>


<div class="viewcode-block" id="RoutePostprocessing.connect_route_segments">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.connect_route_segments">[docs]</a>
    <span class="k">def</span> <span class="nf">connect_route_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_route_seg_gdf</span><span class="p">,</span> <span class="n">separation_lane_gdf</span><span class="p">,</span>
                               <span class="n">last_route_seg_gdf</span><span class="p">,</span> <span class="n">route_segments_gdf</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Create new geometries for new connecting LineStrings before and after separation lanes</span>
        <span class="k">if</span> <span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">first_connecting_seg_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_first_connecting_seg_from_node</span><span class="p">(</span><span class="n">route_segments_gdf</span><span class="p">,</span>
                                                                                   <span class="n">separation_lane_gdf</span><span class="p">)</span>
            <span class="n">first_connecting_seg_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">first_connecting_seg_geom</span><span class="p">],</span>
                                                        <span class="n">crs</span><span class="o">=</span><span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
            <span class="n">first_connecting_seg_gdf</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">starttime_per_step</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_connecting_seg_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_first_connecting_seg</span><span class="p">(</span><span class="n">first_route_seg_gdf</span><span class="p">,</span> <span class="n">separation_lane_gdf</span><span class="p">)</span>
            <span class="n">first_connecting_seg_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">first_connecting_seg_geom</span><span class="p">],</span>
                                                        <span class="n">crs</span><span class="o">=</span><span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">last_route_seg_gdf</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">last_connecting_seg_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_last_connecting_line_from_node</span><span class="p">(</span><span class="n">route_segments_gdf</span><span class="p">,</span>
                                                                                  <span class="n">separation_lane_gdf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_connecting_seg_geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_last_connecting_line</span><span class="p">(</span><span class="n">last_route_seg_gdf</span><span class="p">,</span> <span class="n">separation_lane_gdf</span><span class="p">)</span>

        <span class="n">separation_lane_geom</span> <span class="o">=</span> <span class="n">separation_lane_gdf</span><span class="o">.</span><span class="n">geom</span>

        <span class="c1"># Create new GeoDataFrame with the new connecting LineStrings before and after separation lanes</span>

        <span class="n">seperation_lane_seg_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">separation_lane_geom</span><span class="p">],</span>
                                                   <span class="n">crs</span><span class="o">=</span><span class="n">last_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">last_connecting_seg_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">last_connecting_seg_geom</span><span class="p">],</span>
                                                   <span class="n">crs</span><span class="o">=</span><span class="n">last_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>

        <span class="c1"># Append the new GeoDataFrame to the existing one</span>
        <span class="n">route_first_connecting_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">first_route_seg_gdf</span><span class="p">,</span> <span class="n">first_connecting_seg_gdf</span><span class="p">],</span>
                                                                <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">route_separation_lane_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">route_first_connecting_gdf</span><span class="p">,</span> <span class="n">seperation_lane_seg_gdf</span><span class="p">],</span>
                                                               <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">route_last_connecting_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">route_separation_lane_gdf</span><span class="p">,</span> <span class="n">last_connecting_seg_gdf</span><span class="p">],</span>
                                                               <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">crs</span><span class="o">=</span><span class="n">first_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">final_route</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">route_last_connecting_gdf</span><span class="p">,</span> <span class="n">last_route_seg_gdf</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                       <span class="n">crs</span><span class="o">=</span><span class="n">last_route_seg_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_route</span></div>


<div class="viewcode-block" id="RoutePostprocessing.create_first_connecting_seg">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.create_first_connecting_seg">[docs]</a>
    <span class="k">def</span> <span class="nf">create_first_connecting_seg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_route_seg_gdf</span><span class="p">,</span> <span class="n">separation_lane_gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the LineString between the route node before the first intersection and</span>
<span class="sd">        the first node of the separation lane segment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">separation_lane_gdf</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">first_node_of_separation_lane</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">last_node_of_first_route_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_last_node_of_route_seg</span><span class="p">(</span><span class="n">first_route_seg_gdf</span><span class="p">)</span>
        <span class="n">first_connecting_seg</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([</span><span class="n">last_node_of_first_route_seg</span><span class="p">,</span> <span class="n">first_node_of_separation_lane</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">first_connecting_seg</span></div>


<div class="viewcode-block" id="RoutePostprocessing.create_first_connecting_seg_from_node">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.create_first_connecting_seg_from_node">[docs]</a>
    <span class="k">def</span> <span class="nf">create_first_connecting_seg_from_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route_segment_gdf</span><span class="p">,</span>
                                              <span class="n">separation_lane_gdf</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">separation_lane_gdf</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">first_node_of_separation_lane</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">first_node_of_route_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_first_node_of_route_seg</span><span class="p">(</span><span class="n">route_segment_gdf</span><span class="p">)</span>
        <span class="n">first_connecting_seg</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([</span><span class="n">first_node_of_route_seg</span><span class="p">,</span> <span class="n">first_node_of_separation_lane</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">first_connecting_seg</span></div>


<div class="viewcode-block" id="RoutePostprocessing.create_last_connecting_line">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.create_last_connecting_line">[docs]</a>
    <span class="k">def</span> <span class="nf">create_last_connecting_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_route_seg_gdf</span><span class="p">,</span> <span class="n">separation_lane_gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the LineString between the last node of the separtion lane and the first route node</span>
<span class="sd">        after the last intersection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">separation_lane_gdf</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">last_node_of_separation_lane</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">last_index</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">last_index</span><span class="p">])</span>
        <span class="n">first_node_of_last_route_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_first_node_of_route_seg</span><span class="p">(</span><span class="n">last_route_seg_gdf</span><span class="p">)</span>
        <span class="n">last_connecting_seg</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([</span><span class="n">last_node_of_separation_lane</span><span class="p">,</span> <span class="n">first_node_of_last_route_seg</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">last_connecting_seg</span></div>


<div class="viewcode-block" id="RoutePostprocessing.create_last_connecting_line_from_node">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.create_last_connecting_line_from_node">[docs]</a>
    <span class="k">def</span> <span class="nf">create_last_connecting_line_from_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route_segment_gdf</span><span class="p">,</span> <span class="n">separation_lane_gdf</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the LineString between the last node of the separtion lane and the first route node</span>
<span class="sd">        after the last intersection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">separation_lane_gdf</span><span class="o">.</span><span class="n">geom</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">last_node_of_separation_lane</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">last_index</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">last_index</span><span class="p">])</span>
        <span class="n">last_node_of_route_seg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_last_node_of_route_seg</span><span class="p">(</span><span class="n">route_segment_gdf</span><span class="p">)</span>
        <span class="n">last_connecting_seg</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">([</span><span class="n">last_node_of_separation_lane</span><span class="p">,</span> <span class="n">last_node_of_route_seg</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">last_connecting_seg</span></div>


<div class="viewcode-block" id="RoutePostprocessing.recalculate_starttime_per_node">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.recalculate_starttime_per_node">[docs]</a>
    <span class="k">def</span> <span class="nf">recalculate_starttime_per_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">final_route</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To recalculate the start time of the new route segments, first a new integer index is set</span>
<span class="sd">        to final route segments dataframe. Then, the index of first Not available Timestamp</span>
<span class="sd">        value is searched and start calculating the new time taken from that index to rest</span>
<span class="sd">        of the dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_times_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">route_segment</span> <span class="ow">in</span> <span class="n">final_route</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">route_segment</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_route</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Check if the end point of the current LineString is the same as the start point of the next LineString</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">final_route</span><span class="p">[</span><span class="s1">&#39;geometry&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># If they match, remove the duplicate node</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">start_time</span> <span class="o">=</span> <span class="n">final_route</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
        <span class="n">start_time_datetime_obj</span> <span class="o">=</span> <span class="n">start_time</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
        <span class="n">start_times_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_time_datetime_obj</span><span class="p">)</span>
        <span class="n">array_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">)</span>

        <span class="n">first_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">first_index</span><span class="p">,</span> <span class="n">array_len</span><span class="p">):</span>
            <span class="n">current_timestamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_timsestamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">,</span>
                                                          <span class="n">start_times_list</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ship_speed</span><span class="p">)</span>
            <span class="n">start_times_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_timestamp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">start_times_list</span></div>


<div class="viewcode-block" id="RoutePostprocessing.calculate_timsestamp">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.calculate_timsestamp">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_timsestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">start_times</span><span class="p">,</span> <span class="n">node_index</span><span class="p">,</span> <span class="n">speed</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the time taken using time = distance / ship speed of the previous</span>
<span class="sd">        route segment and then added the new time taken into previous timestamp to</span>
<span class="sd">        get the new start time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">previous_step_index</span> <span class="o">=</span> <span class="n">node_index</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">previous_timestamp</span> <span class="o">=</span> <span class="n">start_times</span><span class="p">[</span><span class="n">previous_step_index</span><span class="p">]</span>
        <span class="n">gcd</span> <span class="o">=</span> <span class="n">geod</span><span class="o">.</span><span class="n">inverse</span><span class="p">([</span><span class="n">lat</span><span class="p">[</span><span class="n">previous_step_index</span><span class="p">]],</span> <span class="p">[</span><span class="n">lon</span><span class="p">[</span><span class="n">previous_step_index</span><span class="p">]],</span>
                           <span class="p">[</span><span class="n">lat</span><span class="p">[</span><span class="n">node_index</span><span class="p">]],</span> <span class="p">[</span><span class="n">lon</span><span class="p">[</span><span class="n">node_index</span><span class="p">]])</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">[</span><span class="s1">&#39;s12&#39;</span><span class="p">]</span>
        <span class="n">time_taken_for_current_step</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">speed</span><span class="o">.</span><span class="n">value</span>
        <span class="n">current_timestamp</span> <span class="o">=</span> <span class="n">previous_timestamp</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">time_taken_for_current_step</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">current_timestamp</span></div>


<div class="viewcode-block" id="RoutePostprocessing.terminate">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.terminate">[docs]</a>
    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route_lons</span><span class="p">,</span> <span class="n">route_lats</span><span class="p">,</span> <span class="n">starttime_list</span><span class="p">,</span> <span class="n">boat_speed</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the courses from route_dict to calculate the ship_parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">route_lons_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">route_lons</span><span class="p">)</span>
        <span class="n">route_lats_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">route_lats</span><span class="p">)</span>
        <span class="n">start_time_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">starttime_list</span><span class="p">)</span>
        <span class="n">route_dict</span> <span class="o">=</span> <span class="n">RouteParams</span><span class="o">.</span><span class="n">get_per_waypoint_coords</span><span class="p">(</span><span class="n">route_lons_np</span><span class="p">,</span>
                                                         <span class="n">route_lats_np</span><span class="p">,</span>
                                                         <span class="n">start_time_np</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                         <span class="n">boat_speed</span><span class="p">)</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;start_times&#39;</span><span class="p">]</span>
        <span class="n">start_times_datetime64</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span>
        <span class="n">ship_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boat</span><span class="o">.</span><span class="n">get_ship_parameters</span><span class="p">(</span><span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;courses&#39;</span><span class="p">],</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;start_lats&#39;</span><span class="p">],</span>
                                                    <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;start_lons&#39;</span><span class="p">],</span> <span class="n">start_times_datetime64</span><span class="p">)</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">last_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">finish</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lats_per_step</span><span class="p">[</span><span class="n">last_index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lons_per_step</span><span class="p">[</span><span class="n">last_index</span><span class="p">])</span>

        <span class="n">travel_times</span> <span class="o">=</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;travel_times&#39;</span><span class="p">]</span>
        <span class="n">courses</span> <span class="o">=</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;courses&#39;</span><span class="p">]</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">]</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="n">route_dict</span><span class="p">[</span><span class="s1">&#39;start_times&#39;</span><span class="p">]</span>
        <span class="n">arrival_time</span> <span class="o">=</span> <span class="n">start_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dists</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">boat_speed</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">travel_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">travel_times</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="n">courses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">courses</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">meter</span><span class="p">)</span>
        <span class="n">start_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start_times</span><span class="p">,</span> <span class="n">arrival_time</span><span class="p">)</span>

        <span class="n">route</span> <span class="o">=</span> <span class="n">RouteParams</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="n">npoints</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                            <span class="n">finish</span><span class="o">=</span><span class="n">finish</span><span class="p">,</span>
                            <span class="n">gcr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">route_type</span><span class="o">=</span><span class="s1">&#39;min_time_route&#39;</span><span class="p">,</span>
                            <span class="n">time</span><span class="o">=</span><span class="n">travel_times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">lats_per_step</span><span class="o">=</span><span class="n">route_lats</span><span class="p">,</span>
                            <span class="n">lons_per_step</span><span class="o">=</span><span class="n">route_lons</span><span class="p">,</span>
                            <span class="n">course_per_step</span><span class="o">=</span><span class="n">courses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">dists_per_step</span><span class="o">=</span><span class="n">dists</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">starttime_per_step</span><span class="o">=</span><span class="n">start_times</span><span class="p">,</span>
                            <span class="n">ship_params_per_step</span><span class="o">=</span><span class="n">ship_params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">route</span></div>


<div class="viewcode-block" id="RoutePostprocessing.find_point_from_perpendicular_angle">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.find_point_from_perpendicular_angle">[docs]</a>
    <span class="k">def</span> <span class="nf">find_point_from_perpendicular_angle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span>
                                            <span class="n">segment</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the intersecting point on a line segment which it makes a perpendicular</span>
<span class="sd">        angle from a given point</span>
<span class="sd">        :param start_node: given point</span>
<span class="sd">        :param segment: given line segment</span>
<span class="sd">        :returns: coordinates of the point on the line which  makes a right angle</span>
<span class="sd">        from the given point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line_x</span><span class="p">,</span> <span class="n">line_y</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">x_start</span> <span class="o">=</span> <span class="n">line_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_start</span> <span class="o">=</span> <span class="n">line_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_end</span> <span class="o">=</span> <span class="n">line_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_end</span> <span class="o">=</span> <span class="n">line_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">start_node</span><span class="o">.</span><span class="n">x</span>
        <span class="n">yp</span> <span class="o">=</span> <span class="n">start_node</span><span class="o">.</span><span class="n">y</span>

        <span class="n">slope</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_slope</span><span class="p">(</span><span class="n">x_start</span><span class="p">,</span> <span class="n">y_start</span><span class="p">,</span> <span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">slope</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">xp</span> <span class="o">-</span> <span class="n">yp</span> <span class="o">-</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_start</span> <span class="o">+</span> <span class="n">y_start</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">slope</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="n">m</span> <span class="o">*</span> <span class="n">xp</span> <span class="o">+</span> <span class="n">yp</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>


<div class="viewcode-block" id="RoutePostprocessing.check_valid_crossing">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.check_valid_crossing">[docs]</a>
    <span class="k">def</span> <span class="nf">check_valid_crossing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">separation_lanes_data_gdf</span><span class="p">,</span>
                             <span class="n">last_node_of_first_route_seg</span><span class="p">,</span>
                             <span class="n">first_node_of_last_route_seg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This checks whether the straight line starting from the point before the intersection</span>
<span class="sd">        and ending from the point after the last intersection makes an angle between 60 to 120</span>
<span class="sd">        with respect to the nearest separation lane of the starting point.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">intersecting_route_seg_geom</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">last_node_of_first_route_seg</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">last_node_of_first_route_seg</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
             <span class="p">(</span><span class="n">first_node_of_last_route_seg</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">first_node_of_last_route_seg</span><span class="o">.</span><span class="n">y</span><span class="p">)])</span>
        <span class="n">intersecting_route_seg_gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="n">geometry</span><span class="o">=</span><span class="p">[</span><span class="n">intersecting_route_seg_geom</span><span class="p">],</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">separation_lanes_data_gdf</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
        <span class="n">intersecting_separation_lanes</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">intersecting_route_seg_gdf</span><span class="p">,</span>
                                                    <span class="n">separation_lanes_data_gdf</span><span class="p">,</span>
                                                    <span class="n">how</span><span class="o">=</span><span class="s1">&#39;intersection&#39;</span><span class="p">,</span>
                                                    <span class="n">keep_geom_type</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersecting_separation_lanes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">merged_separation_lanes_data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">intersecting_separation_lanes</span><span class="p">,</span> <span class="n">separation_lanes_data_gdf</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
            <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        <span class="n">dist_to_separation_lane</span> <span class="o">=</span> <span class="n">last_node_of_first_route_seg</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span>
            <span class="n">merged_separation_lanes_data_df</span><span class="p">[</span><span class="s1">&#39;geom&#39;</span><span class="p">])</span>
        <span class="n">min_dist_indx</span> <span class="o">=</span> <span class="n">dist_to_separation_lane</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
        <span class="n">separation_lane</span> <span class="o">=</span> <span class="n">merged_separation_lanes_data_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">min_dist_indx</span><span class="p">]]</span>
        <span class="n">angle_current_crossing</span><span class="p">,</span> <span class="n">separation_lane_segment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_angle_of_current_crossing</span><span class="p">(</span>
            <span class="n">last_node_of_first_route_seg</span><span class="p">,</span> <span class="n">first_node_of_last_route_seg</span><span class="p">,</span>
            <span class="n">separation_lane</span><span class="p">,</span> <span class="n">intersecting_route_seg_geom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">angle_current_crossing</span> <span class="o">&gt;=</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">angle_current_crossing</span> <span class="o">&lt;=</span> <span class="mi">120</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">separation_lane_segment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="RoutePostprocessing.calculate_slope">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.calculate_slope">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the slope of a line from the two given points on the same line</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slope</span></div>


<div class="viewcode-block" id="RoutePostprocessing.calculate_angle_from_slope">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.calculate_angle_from_slope">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_angle_from_slope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate angle between two lines when the slopes of the two lines are given</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">s1</span><span class="o">*</span><span class="n">s2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mf">90.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">((</span><span class="n">s1</span> <span class="o">-</span> <span class="n">s2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">s1</span> <span class="o">*</span> <span class="n">s2</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="RoutePostprocessing.calculate_angle_of_current_crossing">
<a class="viewcode-back" href="../../../source/api-documentation/WeatherRoutingTool.constraints.html#WeatherRoutingTool.constraints.route_postprocessing.RoutePostprocessing.calculate_angle_of_current_crossing">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_angle_of_current_crossing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_node</span><span class="p">,</span> <span class="n">end_node</span><span class="p">,</span>
                                            <span class="n">separation_lane_gdf</span><span class="p">,</span>
                                            <span class="n">intersecting_route_seg_geom</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the angle between the straight line which starts from the point before first</span>
<span class="sd">        intersection and ends after the last intersection with respect to the intersecting</span>
<span class="sd">        separation lane segment. Separation lane can contains multiple line segments.</span>
<span class="sd">        :param start_node: starting node of the straight line</span>
<span class="sd">        :param end_node: ending node of the straight line</span>
<span class="sd">        :param separation_lane_gdf: separation lanes</span>
<span class="sd">        :param intersecting_route_seg_geom: route segment which is intersecting the separation</span>
<span class="sd">        lane</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">slope_route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_slope</span><span class="p">(</span><span class="n">start_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">start_node</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                                           <span class="n">end_node</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">end_node</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">separation_lane_gdf</span><span class="o">.</span><span class="n">geom</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">separation_lane_segment</span> <span class="o">=</span> <span class="n">LineString</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">line</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">separation_lane_segment</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">intersecting_route_seg_geom</span><span class="p">):</span>
                    <span class="n">point_x</span><span class="p">,</span> <span class="n">point_y</span> <span class="o">=</span> <span class="n">separation_lane_segment</span><span class="o">.</span><span class="n">xy</span>
                    <span class="n">slope_separation_lane</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_slope</span><span class="p">(</span><span class="n">point_x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                 <span class="n">point_y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                 <span class="n">point_x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                 <span class="n">point_y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">angle_current_crossing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_angle_from_slope</span><span class="p">(</span>
                        <span class="n">slope_route</span><span class="p">,</span>
                        <span class="n">slope_separation_lane</span><span class="p">)</span>
                    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">angle_current_crossing</span><span class="p">),</span> <span class="n">separation_lane_segment</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">WeatherRoutingTool</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/conventions.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/constraints/index.html">Constraints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/consumption-models/index.html">Consumption models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/weather.html">Weather data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/api-documentation/index.html">API documentation (still under construction!)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/uml.html">UML Class diagrams</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, 52°North Spatial Information Research GmbH.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>